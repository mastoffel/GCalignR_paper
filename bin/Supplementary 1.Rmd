---
title: 'Supplementary for "GCalignR: An R package for aligning Gas-Chromatography data"'
author: "Meinolf Ottensmann, Martin A. Stoffel and Joseph I. Hoffman"
date: '`r Sys.Date()`'
output:
  pdf_document:
    fig_caption: yes
    highlight: kate
    keep_tex: yes
    number_sections: no
  html_document:
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: no
    theme: cerulean
  word_document: default
bibliography: bibliographyMO.bib
---

```{r, echo = FALSE, results = 'hide'}
library(knitcitations)
  cleanbib()
  cite_options(citation_format = "pandoc", check.entries = FALSE)
  library(bibtex)
  library(pander)
``` 

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", cache = FALSE) 
```

This document provides all code necessary code to run all relevant analyses presented in our paper. The *Rmarkdown* file as well as the data are best
accessed by downloading this [GitHub](https://github.com/mastoffel/GCalignR_paper) repository. 

## Prerequisites
A couple of packages need to be available during the **R** session to produce all analyses and plots:
```{r, results='hide'}
# if packages are not installed, load them from CRAN
wants <- c("vegan","ggplot2","gridExtra","grid")
has   <- wants %in% rownames(installed.packages())
if (any(!has)) install.packages(wants[!has])
library(GCalignR)  
library(ggplot2)
library(vegan)
library(gridExtra)
library(grid)
```


## Data
We demonstrate the usage of `GcalignR` with two empirical data sets. A more detailed workthrough tutorial is given in the \href{../doc/GCalignR_step_by_step.html}{vignette}. 

### Bumble bee cephalic secretions

@Dellicour.2013 present data for three North America bumble bee species *Bombus bimaculatus*, *B. ephippiatus* and *B. flavifrons*. Samples represent cephalic labial gland secretions and are supposed to show species specific patterns [@Meulemeester.2011]. Hence, this in an ideal data set to test both (i) the alignment efficiency of **GCalignR** and (ii) the functionality to explore similarity patterns by multidimensional scaling within one pipeline in **R**. The chromatogram data was extracted from Table S1 of [@Dellicour.2013] and can be downloaded here: {http://onlinelibrary.wiley.com/store/10.1002/jssc.201300388/asset/supinfo/jssc3437-sup-0001-TableS1.zip?v=1&s=57d5d58273d1d4207e70c72cecd5bba4b1fe95a1}{Supporting information}. We prepared a table that links each sample to the corresponding species.

```{r, results = "asis"}
## Load factors
bee_factors <- read.csv("data/d1/Table_S1_factors.csv",sep = ";")
row.names(bee_factors) <- bee_factors[["ID"]]
# In total 55 samples are available
pander::pandoc.table(bee_factors[c(1:2,25:26,45:46),], caption = "Factors for Bumble bee data")
``` 

Prior to excecuting any alignment, the conformity of the data with the requirements of `GCalignR`is tested "behind the scenes". Nonetheless, this can be invoked manually by calling the function `check_input`.
```{r}
check_input(data = "data/d1/Table_S1_raw.txt")
```
The output reveals that sample *BEPH06* is malformed. The last row contains both area and relative area but no retention time. It is unclear what this represents. The respective row is removed from the file we are going to use afterwards.

### Antarctic fur seal *Arctocephalus gazella* skin swabs
The second data set is comprised of skin swabs of 41 mother-pup pairs of Antarctic fur seals *Arctocephalus gazella* which among other things were shown to encode the membership to a breeding colony [@Stoffel.2015]. These data are distributed with our package and available as the list \code{peak_data} with corresponding factors \code{peak_factors}

```{r}
# chemical data
data("peak_data")
# corresponding factors
data("peak_factors")
pander::pandoc.table(head(peak_factors), caption = "Factors for Seal data")
```

## Alignment
* Aligning the bumblee bee data

```{r, eval = FALSE, results = 'hide'}
bumble_bee_aligned <- align_chromatograms(data = "data/bumblee_bee_input.txt",
                                   conc_col_name = "Area",
                                   max_diff_peak2mean = 0.02,
                                   min_diff_peak2peak = 0.05,
                                   max_linear_shift = 0.05,
                                   rt_col_name = "RT",
                                   delete_single_peak = T)
save(bumble_bee_aligned, file = "data/bumble_bee_aligned.RData")
```
```{r}
# The alignment was performed in 3:30 minutes.
load(file = "data/bumble_bee_aligned.RData")
```

* Aligning the fur seal data

```{r, eval = FALSE, results = 'hide'}
seal_aligned <- align_chromatograms(data = peak_data,
                    conc_col_name = "area",
                    max_diff_peak2mean = 0.02,
                    min_diff_peak2peak = 0.05,
                    rt_col_name = "time",
                    delete_single_peak = T,
                    blanks = c("C2","C3"),
                    rt_cutoff_low = 8,
                    iterations = 1)
save(seal_aligned, file = "seal_aligned.RData")
```
```{r}
# The computation took 24:59 Minutes
load(file = "data/d1/seal_aligned.RData")
```

## Inspect the aligned data
* Heatmaps show the distribution of peaks and can highlight deviations
```{r}
plot.bee1 <- gc_heatmap(bumble_bee_aligned, threshold = 0.07, main_title = paste("Bumblee bee data"),
                        label = F)
plot.seal1 <- gc_heatmap(seal_aligned, threshold = 0.07, main_title = "Fur seal data",
                         label = F, show_legend = F)
heatmaps <- gridExtra::grid.arrange(plot.bee1,plot.seal1)
grid::grid.newpage()
grid::grid.draw(heatmaps)
```
* Diagnostic plots aid in finetuning of the alignment
```{r}
plot(seal_aligned)
```

* Exploring species similarites with non-metric multidimensional scaling (NMDS) 
```{r,results = "hide"}
# normalise abundancies within samples
bumble_bee_scent <- GCalignR::norm_peaks(bumble_bee_aligned,conc_col_name = "Area",rt_col_name = "RT",out = "data.frame")
# Log + 1 Transformation
bumble_bee_scent <- log(bumble_bee_scent + 1) 
bumble_bee_scent <- bumble_bee_scent[match(row.names(bee_factors),row.names(bumble_bee_scent)),] 
# NMDS using bray-curtis in vegan
bumble_bee_scent_nmds <- vegan::metaMDS(comm = bumble_bee_scent,trymax = 9999) 
# Get the coordinates
bumble_bee_scent_nmds <- as.data.frame(bumble_bee_scent_nmds$points) 
bumble_bee_scent_nmds <- cbind(bumble_bee_scent_nmds,Species = bee_factors[["Species"]])  
```

* Visualisation using `ggplot2`
```{r}
ggplot2::ggplot(data = bumble_bee_scent_nmds,ggplot2::aes(MDS1,MDS2,color = Species)) +
ggplot2::geom_point(size = 3) + 
ggplot2::stat_ellipse(size = 2) + 
ggplot2::labs(title = "", x = "MDS1", y = "MDS2") +
ggplot2::theme_bw(base_size = 14) + 
ggplot2::theme(axis.ticks = element_blank(), axis.text = element_blank()) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3,"Dark2"), 
    name = "",
    breaks = c("bimaculatus", "ephippiatus", "flavifrons"),
    labels = c("Bombus bimaculatus","B. ephippiatus","B. flavifrons"),
    guide = guide_legend(label.theme = element_text(
    face = "italic", angle = 0, size = 11)))
```
* Multivariate statistics using `adonis` reveal a highly significant clustering by species
```{r}
vegan::adonis(bumble_bee_scent ~ bee_factors$Species,permutations = 999)
```

* Exploring species similarites with non-metric multidimensional scaling (NMDS) 
```{r,results = "hide"}
# normalise abundancies within samples
seal_scent <- GCalignR::norm_peaks(seal_aligned,conc_col_name = "area",rt_col_name = "time",out = "data.frame")
# Log + 1 Transformation
seal_scent <- log(seal_scent + 1) 
seal_scent <- seal_scent[match(row.names(peak_factors),row.names(seal_scent)),] 
# NMDS using bray-curtis in vegan
seal_scent_nmds <- vegan::metaMDS(comm = seal_scent,trymax = 9999) 
# Get the coordinates
seal_scent_nmds <- as.data.frame(seal_scent_nmds$points) 
seal_scent_nmds <- cbind(seal_scent_nmds,colony = peak_factors[["colony"]])  
```

* Visualisation using `ggplot2`
```{r}
ggplot2::ggplot(data = seal_scent_nmds,ggplot2::aes(MDS1,MDS2,color = colony)) +
ggplot2::geom_point(size = 3) + 
ggplot2::stat_ellipse(size = 2) + 
ggplot2::labs(title = "", x = "MDS1", y = "MDS2") +
ggplot2::theme_bw(base_size = 14) + 
ggplot2::theme(axis.ticks = element_blank(), axis.text = element_blank()) +
    scale_colour_manual(values = RColorBrewer::brewer.pal(3,"Dark2")[c(1,2)], 
    name = "",
    breaks = c("FWB", "SSB"),
    labels = c("Freshwater beach","Special study beach"),
    guide = guide_legend(label.theme = element_text(
    face = "italic", angle = 0, size = 11)))
```
* Multivariate statistics using `adonis` reveal a highly significant clustering by species
```{r}
vegan::adonis(bumble_bee_scent ~ bee_factors$Species,permutations = 999)
```
***
R version and platform.
```{r}
sessionInfo()
```
***

## References