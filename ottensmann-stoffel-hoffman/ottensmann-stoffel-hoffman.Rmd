---
title: GCalignR. An R package for aligning Gas-Chromatography data 
author:
  - name: Meinolf Ottensmann
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  Meinolf.Ottensmann@web.de
  - name: Martin A. Stoffel
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  Martin.Adam.Stoffel@gmail.com
  - name: Joseph I. Hoffman
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  j_i_hoffman@hotmail.com

abstract: >
  This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract This is just a placeholder for 150 words in the abstract

preamble: >
  % Any extra latex you need in the preamble
output: rticles::rjournal_article
---



\section{Introduction}
Chemical cues are arguably the most common mode of communication among animals \citep{Wyatt.2014}. By exploring broad patterns in complex chemical signatures, researchers make inferences on kinship \citep{Krause.2012, Stoffel.2015}, genetic diversity \citep{Charpentier.2010, Leclaire.2012}, sexual maturation \citep{Caspers.2011} or species discrimination \citep{Meulemeester.2011}. One of the most common instruments to quantify the chemical composition of samples is gas-chromatography, a fast high-throughput method to detect individual chemicals and their abundances \citep{McNair.2011}, while the additional implementation of mass-spectrometry (GC-MS) allows to identify specific substances \citep{Caspers.2011}. \par
However, before similarity patterns across can be analysed, it is essential to align compounds among samples, thereby accounting for drifts in the retention times of peaks caused by subtle, random and often unavoidable variations of the chromatography machine parameters \citep{Pierce.2005}. Many studies rely on manual alignment rather than (semi-)automated algorithms (citations necessary), but this approach bears three severe drawbacks: (1) In large scale studies this task becomes increasingly time consuming task and is impracticable. (2) Humans are prone to detect patterns in noise which is why the researcher may bias the alignment due to subjective experience and expectations. (3) The data analytic pipeline from the raw gas-chromatography data to the results of the statistical analysis is not reproducible. (citations for the first two points necessary)
Several alignment algorithms have been proposed to overcome these issues, but these focus nearly exclusively on GC-MS data \citep{Pierce.2005, Robinson.2007,Jiang.2013} and only some a easily accessible as web-based tools \citep{Hoffmann.2009, Wang.2010} or independent software \citep{Dellicour.2013}.  \par
Here, we introduce \pkg{GCalignR}, a package that implements a simple and fast algorithm to align peaks from GC data and evaluate the resulting alignment using two data sets. \pkg{GCalignR} was specifically developed as a tool for pre-processing GC data from animal skin and preen glands prior to subsequent statistical analysis. In brief, the algorithm consists of two main steps: (1) Systematic shifts of chromatograms are corrected by applying appropriate linear shifts to whole chromatograms based on a single reference. (2) Retention times of individual peaks are grouped iteratively together with homologous peaks of other samples and aligned within the same row in a retention time matrix . The quality of this grouping procedure can be adjusted to specific datasets through three parameters that are described in detail below. Among several optional processing steps, the package allows to remove peaks belonging to contaminations, which are identified due to their presence in control samples. For an easy interpretation of the quality of an alignment we implemented several ways to plot the outcome (You can change this to something more specific).
Furthermore, we demonstrate a complete workflow from chemical raw data to multivariate analyses with the popular and widely used \href{https://cran.r-project.org/web/packages/vegan/index.html}{\CRANpkg{vegan}} \citep{Oksanen.2016} package. This allows the integration of the full analysis into \strong{RMarkdown} documents \citep{Allaire.2016} in order to meet the standards of reproducibility \citep{Peng.2011}.

\section{The Package}
\pkg{GCalignR} consists of functions that allow the alignment of peaks from GC and GC-MS data based on retention times. The main aim of the package is to provide a simple tool that guides the user through the alignment of large data sets prior to hypothesis-testing of the multivariate data \citep{Anderson.2001}. We summarise the underlying algorithm and workflow (figure \ref{figure:workflow}) below and refer to the vignette that can be assessed via \code{browseVignettes('GCalignR')}.

\begin{figure}[htbp]
  \centering
  \includegraphics[width=13cm]{figures/workflow}
  \caption{\pkg{GCalignR} workflow. In addition to the alignment of substances across samples, the package provides functions for checking and inspecting the data. The aligned data is ready to use for analyses in conjunction with other packages. Each function is explained within the text.}
  \label{figure:workflow}
\end{figure}

\subsection{Example datasets}
For demonstration purposes \pkg{GCalignR} includes data of chemical signatures that were obtained by sampling the skin of 82 Antarctic fur seals \textit{Arctocephalus gazella}. It was previously shown that these signatures encode the membership to a breeding colony \cite{Stoffel.2015}. These data are available as a \emph{List} with individual samples included as a \emph{data.frame}. Two variables are available that represent the required retention time ("time") and concentration or peak abundance ("area") within a sample. 

```{r}
library(GCalignR)
# Seal scent data
data("peak_data") 
# Data is organized in one list of data.frames
str(peak_data[1:2]) 
```

The second data set is comprised of three bumble bee species \textit{Bombus bimaculatus}, \textit{B. ephippiatus} and \textit{B. flavifrons} where signatures have been obtained from cephalic labial gland secretions of 24, 20 and 11 individuals respectively \citep{Dellicour.2013}. Cephalic secretions haven been demonstrated to aid in species identification \citep{Meulemeester.2011}. These data are available in a text file (figure \ref{figure:text}) in the format of typical output from proprietary peak detection software (e.g. XCalibur, Thermofischer Scientific or Labsolution, Shimadzu). Here, the names of samples and variables are given in the first two rows, while the peak data is included from below with single matrices concatenated horizontally.
\begin{figure}[htbp]
  \centering
  \includegraphics[width=8cm]{figures/text}
  \caption{Text files are the standard input of \pkg{GCalignR}}
  \label{figure:text}
\end{figure} 

\subsection{Checking the input}
The package provides the function \strong{check{\_}input} checks the input for typical formatting errors and incomplete data. We encourage to use unique names for samples that consist only of letters, numbers and underscores. If the data fails the test, indicative warnings are returned which guide in correcting the errors. In addition, the argument \textit{list{\_}peaks} allows to create a barplot of the initial peak distribution to get an overview of the data.

```{r}
check_input(peak_data)
#> All checks passed!
#> Ready for processing with align_chromatograms
```

\section{Aligning substances among samples}
The alignment procedure is divided into five steps (figure \ref{figure:algorithm}). All steps are executed by the main function \textit{align{\_}chromatograms} and will be explained in in the next sections.
\subsubsection{Linear adjustments of chromatograms}
At first, chromatograms are linearly shifted with respect to a reference sample to account for systematic shifts in retention times among homologous chemicals shared by samples. Therefore, the same small linear adjustments are applied to the entire set of peaks in a chromatogram (figure \ref{figure:algorithm} A), such that the number of peaks that are shared between the sample and the reference at a given threshold (i.e. 0.6 seconds) is maximised.The parameter \textit{max{\_}linear{\_}shift} defines the maximum of linear shifts that are considered by the program. \newline
Note: This method relies on the occurrence of substances that are shared among most substances to produce efficient adjustments. If those are absent, it is unlikely to find a suitable shift and chromatograms remain untransformed. \par
A reference may be selected automatically by searching for the sample with the highest average similarity to all other samples based on the number of shared peaks prior to alignment. Alternatively, a chromatogram may be included that contains peaks of an internal standard which peaks are \textit{a-priori} known to occur in all samples. In this case, the sample should be named \code{"reference"} and will be removed after the alignment was conducted.

\newpage
\begin{figure}[htbp]
  \centering
  \includegraphics[width=13cm]{figures/algorithm}
  \caption{Overview of the algorithm performed by GCalignR. Row of matrices correspond to substances, columns are samples. Zeros indicate absence of peaks and are ignored in calculations. \strong{A}. Chromatograms are linearly shifted with respect to a reference (S2). Strong{B}. From left to right the first four steps from the input matrix to the final alignment are shown. Peaks are aligned row by row. Initially, always the second sample is compared to the first. Then the next sample is compared to all samples in previous columns until the last column is reached. Coloured cells represent conflicting retention times using \textit{max{\_}peak2mean = 0.02}. \strong{C}. After all peaks have been aligned, rows are merged depending on \textit{min{\_}peak2peak}, which defines the minimum difference that is expected between substances. If merging does not result in the loss of any data, rows are merged. \strong{D}. If specified, all peaks found in one or more blanks are removed as well as the blank itself. \strong{E}. Unique peaks which are present in only a single individual are not of interest for similarity analyses and can be removed as well.}
  \label{figure:algorithm}
\end{figure} 

\subsubsection{Piece-wise alignment of substances}
The core of the alignment procedure is based on clustering of individual peaks among samples. This is performed by examining retention times within single rows, where samples are compared consecutively with all previous samples starting with the second column (figure \ref{figure:algorithm} B):\par
If
\begin{equation}
rt_{m} > \left(\frac{\sum_{i=1}^{m-1}rt_{i}}{m-1}\right) + max{\_}peak2mean
\end{equation}
the examined peak is moved into the next row, whereas all previous samples are moved \par
if
\begin{equation}
rt_{m} < \left(\frac{\sum_{i=1}^{m-1}rt_{i}}{m-1}\right) - max{\_}peak2mean
\end{equation}  
with \textit{rt} = retention time; \textit{m} = current column and \textit{max{\_}peak2mean} defining the maximal deviation of the mean retention time.
\newline By considering the mean retention time among all previous samples the algorithm accounts for substance specific variations, such that less variable retention times are treated more stringent than chemicals exhibiting higher variability. Once the last retention time of a row was evaluated the whole procedure is repeated with the next row until the end of the retention time matrix was reached. Afterwards, rows with similar mean retention times are assessed for redundancy (figure \ref{figure:algorithm} C), which applies whenever a merging does not cause any loss of any information (i.e. no sample exists that contains substances in both rows). The similarity threshold is given by \textit{min{\_}peak2peak} defining the minimal difference between peaks that is expected.
\par In combination these two fairly simple algorithms align compounds by considering compound-specific variation in both steps.

\subsubsection{Normalisation}
Many multivariate analysis techniques, like those available in \pkg{vegan}, require a data frame of independent variables as input format. Moreover is generally advisable to normalise abundancies prior to statistical analysis to correct for variations in the total concentration of samples. This is utilised in \pkg{GCalignR´s} function \code{normalise_peaks} which normalises peak abundancies by calculating realtive abundancies for each sample.  

\section{Workflow}
Here, we demonstrate the typical workflow using our seal data. This is done using the function \code{align{\_}chromatograms}. A list of all parameters and their description can be assessed from the documentation in the helpfile by typing \code{?align{\_}chromatograms}:

```{r, eval = FALSE}
seal_aligned <- align_chromatograms(data = peak_data,
                    conc_col_name = "area",
                    max_diff_peak2mean = 0.02,
                    min_diff_peak2peak = 0.05,
                    max_linear_shift = 0.05,
                    rt_col_name = "time",
                    delete_single_peak = T,
                    blanks = c("C2","C3"))
```
```{r, echo=FALSE}
library(GCalignR)
seal_aligned <- aligned_peak_data
```

Now, we can inspect the results by retrieving summaries of the alignment process. The printing method summarises the function call including defaults that have not been explicitly specified during the function call. We also get the relevant information to retrace every step in the alignment:

```{r}
print(seal_aligned)
```

The quality of an alignment will depend on sensible parameters that facilitate the (i) correction of linear shifts that might fall in a larger range with increasing sample size and (ii) and the variability of retention times. Optimally, linear shifts do not exhaust the range given by \code{max{\_}linear{\_}shift} completely, which would in turn indicate that not all uncertainties haven been fully compensated for. This can be assessed by some diagnostic plots:
```{r}
plot(seal_aligned)
```

\bibliography{ottensmann-stoffel-hoffman}