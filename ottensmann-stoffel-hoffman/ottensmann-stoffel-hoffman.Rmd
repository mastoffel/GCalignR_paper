---
title: GCalignR. An R package for aligning Gas-Chromatography data 
author:
  - name: Meinolf Ottensmann
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  Meinolf.Ottensmann@web.de
  - name: Martin A. Stoffel
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  Martin.Adam.Stoffel@gmail.com
  - name: Joseph I. Hoffman
    affiliation: Department of Animal Behaviour
    address:
    - Bielefeld University
    - Morgenbreede 45
    - 33615 Bielefeld
    email:  j_i_hoffman@hotmail.com

abstract: >
  Chemical signals are among the most fundamental and oldest means of animal communication. The desire to unravel broader patterns of chemical communication in birds and mammals paved the way for two not entirely new techniques, gas-chromatography and mass-spectrometry, in the fields of ecology and evolution. Comparing chemical profiles or chromatograms across many individuals yields some major obstacles as even the newest GC machines have an inherent error when measuring the retention times of chemical substances. Here we present GCalignR, an R package for the alignment of chromatography peaks among samples prior to multivariate statistical analysis. GCalignR is specifically designed to be used by non-chemists by providing easy to use functions to check and align gas-chromatography data based on retention times. In addition, the package implements heatmaps and other plots to evaluate and potentially adjust the peak alignment. We hope that GCalignR will provide a tool that fits into a common biologist's workflow in R and that the package will facilitate the standardization and reproducibility of studies on chemical communication.

preamble: >
  % Any extra latex you need in the preamble
output: rticles::rjournal_article
---

## Introduction
Chemical cues are arguably the most common mode of communication among animals \citep{Wyatt.2014}. Patterns in complex chemical signatures can can yield information about kinship \citep{Krause.2012, Stoffel.2015}, genetic diversity \citep{Charpentier.2010, Leclaire.2012}, sexual maturation \citep{Caspers.2011} or be used for species discrimination \citep{Meulemeester.2011}. One of the most common instruments to quantify the chemical composition of samples is gas-chromatography (GC), a fast high-throughput method to detect individual chemicals and their abundances \citep{McNair.2011}, while the additional implementation of mass-spectrometry (GC-MS) allows to identify specific substances \citep{Caspers.2011}. \par
However, before similarity patterns across can be analysed, it is essential to align compounds among samples. The alignment of samples has to account for drifts in the retention times of peaks which are caused by subtle, random and often unavoidable variations of the chromatography machine parameters \citep{Pierce.2005}. Surprisingly, studies on mammalian or avian chemical communication often rely on manual alignment rather than (semi-)automated algorithms (citations necessary), but this approach bears three severe drawbacks: (1) For larger sample sizes, this task becomes extremely time consuming and inefficient (2) The researcher may bias the alignment due to subjective experience and expectations. (3) The data analytical pipeline from the raw gas-chromatography data to the results of the statistical analysis is not reproducible. (citations for the first two points necessary)
Several alignment algorithms have been proposed to overcome these issues, but these focus nearly exclusively on GC-MS data \citep{Pierce.2005, Robinson.2007,Jiang.2013} and only some are easily accessible as web-based tools \citep{Hoffmann.2009, Wang.2010} or independent software \citep{Dellicour.2013}.  \par
Here, we introduce `GCalignR`, an R package that implements a simple algorithm to align peaks purely from retention time data obtained by GC and provides sophisticated visualisations for the evaluation of the alignment quality. `GCalignR` was specifically developed as a tool for pre-processing GC data from animal skin and preen glands prior to subsequent statistical analysis. In brief, the algorithm consists of two main steps: (1) Systematic shifts of chromatograms are corrected by applying appropriate linear shifts to whole chromatograms based on a single reference. (2) Retention times of individual peaks are grouped iteratively together with homologous peaks of other samples and aligned within the same row in a retention time matrix . The quality of this grouping procedure can be adjusted to specific datasets through three parameters that are described in detail below. Among several optional processing steps, the package allows to remove peaks belonging to contaminations, which are identified due to their presence in control samples. For an easy interpretation of the quality of an alignment we implemented several ways to plot the outcome (You can change this to something more specific).
Furthermore, we demonstrate a complete workflow from chemical raw data to multivariate analyses with the popular and widely used \href{https://cran.r-project.org/web/packages/vegan/index.html}{\CRANpkg{vegan}} \citep{Oksanen.2016} package. This allows the integration of the full analysis into \strong{RMarkdown} documents \citep{Allaire.2016} in order to meet the standards of reproducibility \citep{Peng.2011}.

## The Package
`GCalignR` contains functions to align peaks from GC and GC-MS data based on retention times and evaluate the respective alignments. The main aim of the package is to provide a simple tool that guides the user through the alignment of large data sets prior to the statistical analysis of multivariate chemical data \citep{Anderson.2001} (why a citation here?). 
An easy workflow for the analysis of chemical data including `GCalignR` is shown below (figure \ref{figure:workflow}). The package vignette provides a detailed description of all functions and their argumentsand can be assessed via \code{browseVignettes('GCalignR')}. However, the 

\begin{figure}[htbp]
  \centering
  \includegraphics[width=13cm]{figures/workflow}
  \caption{\pkg{GCalignR} workflow. In addition to the alignment of substances across samples, the package provides functions for checking and inspecting the data. The aligned data is ready to use for analyses in conjunction with other packages. Each function is explained within the text.}
  \label{figure:workflow}
\end{figure}


#### Example dataset

For demonstration purposes `GCalignR` includes data of skin chemicals from 82 Antarctic fur seals \textit{Arctocephalus gazella}. It was previously shown that these signatures encode the membership to a breeding colony \cite{Stoffel.2015}. These data are available in a single text file, the standard input format of `GCalignR`, that is distributed with the package. The first two lines contain the names of all samples and variables respectively. From the third row onwards, data of all samples is included, whereby data frames are concatenated horizontally.

```{r,echo=FALSE,results='hide'}
library(GCalignR)
```

```{r}
# Path to the dataset
fpath <- system.file("extdata", "peak_data.txt", package = "GCalignR")
```
```{r,eval=FALSE}
# Open the file in an external editor
system.file("extdata", "peak_data.txt", package = "GCalignR")
```

### Alignment of Gas-Chromatography peaks among samples

The alignment procedure is divided into five steps (figure \ref{figure:algorithm}). All steps are executed within the main function `align_chromatograms` and will be explained in in the next sections.

#### (1) Linear adjustments of chromatograms

At first, all peaks within a chromatogram are shifted with respect to a reference chromatogram to account for systematic shifts in retention times among homologous chemicals shared by samples (figure \ref{figure:algorithm} A). This is done for all samples in relation to the reference sample such that the number shared peaks is maximised.The parameter *max_linear_shift* defines the maximum temporal range of linear shifts that are considered by the program. \newline
Note: This method relies on the occurrence of substances that are shared among most substances to produce efficient adjustments. If those are absent, it is unlikely to find a suitable shift and chromatograms remain untransformed. \par
A reference is selected automatically by searching for the sample with the highest average similarity to all other samples based on the number of shared peaks prior to alignment. Alternatively, a chromatogram can be included that contains peaks of an internal standard which peaks are \textit{a-priori} known to occur in all samples. In this case, the sample is named `reference` and will be removed after the alignment was conducted.


\newpage
\begin{figure}[htbp]
  \centering
  \includegraphics[width=13cm]{figures/algorithm}
  \caption{Overview of the algorithm performed by GCalignR. Rows of matrices correspond to substances, columns are samples. Zeros indicate absence of peaks and are ignored in calculations. \textbf{1}. Chromatograms are linearly shifted with respect to a reference (S2). \textbf{2}. From left to right the first four steps from the input matrix to the final alignment are shown. Peaks are aligned row by row. Initially, always the second sample is compared to the first. Then the next sample is compared to all samples in previous columns until the last column is reached. \textbf{3}. Coloured cells represent conflicting retention times using a minumum \code{max\textunderscore diff\textunderscore peak2mean = 0.02}, which defines the minimum difference expected between two distinct substances. If merging does not result in the loss of any data, rows are merged. \textbf{4}.  If specified, all peaks found in one or more blanks (negative controls) are removes as well as the blank itself. Unique peaks present in only a single individual are not of interest for similarity analyses and can be removed as well.}
  \label{figure:algorithm}
\end{figure} 

#### (2)  Peak alignment
The core of the alignment procedure is based on clustering of individual peaks across samples. This is performed by examining retention times within single rows, where samples are compared consecutively with all previous samples starting with the second column (figure \ref{figure:algorithm} B):\par

\begin{equation}
rt_{m} > \left(\frac{\sum_{i=1}^{m-1}rt_{i}}{m-1}\right) + max\textunderscore peak2mean
\end{equation}


If the examined peak is moved into the next row, whereas all previous samples are moved \par
\begin{equation}
rt_{m} < \left(\frac{\sum_{i=1}^{m-1}rt_{i}}{m-1}\right) - max\textunderscore peak2mean
\end{equation}  

with \textit{rt} = retention time; \textit{m} = current column and \textit{max\textunderscore diff\textunderscore peak2mean} defining the maximal deviation of the mean retention time.

By considering the mean retention time among all previous samples the algorithm accounts for substance specific variations, such that less variable retention times are treated more stringent than chemicals exhibiting higher variability. Once the last retention time of a row was evaluated the whole procedure is repeated with the next row until the end of the retention time matrix was reached. 

#### (3)  Merging

Sometimes, a single substance has been split up into two different rows. However, the emerging pattern is very clear, as part of the samples will have the substance in a given row, but no substance in the adjacent row and vice versa for another part of the samples. Knowing this pattern, rows will be merged when this does not cause any loss of any information (i.e. no sample exists that contains substances in both rows).(figure \ref{figure:algorithm} C). Again, the user can change the threshold  for the minimal difference in the retention time between two mergeable peaks with \textit{min\textunderscore diff\textunderscore peak2peak}. 
\par 

#### (4) Post processing

After aligning peaks the package offers several optional post processing steps that allow to cleanup the data. 

##### Removing contaminations
Among other sources, residues of unwanted chemical substances in the gas chromtography column or within reagents used in the laboratory have the potential to contaminate chemical samples. To get rid of these substances it is generally advised to include control samples. Within `align_chromatograms` those controls can be included in the data set in the same way as a normal sample. By specifying the name of one or more control samples with the `blanks = c("contr1", "contr2"),` all substances present in the control samples are removed from the dataset.

#####  Removing single peaks

Sometimes, substances occur purely in a single sample. For comparative approaches that calculate similarity matrices these substances are often not informative and can be removed from the data. `GCalignR` allows to do so by setting the `delete_single_peak` argument to `TRUE`.

#####  Normalisation

Many multivariate analysis techniques, like those available in \pkg{vegan}, require a `data,frame` of independent variables as input format. Moreover it is generally advisable to normalise substance abundances prior to statistical analysis to correct for variations in the total concentration of samples. This can be done in `GCalignR` with the function `normalise_peaks` which calculate relative abundances within each sample.  


## Workflow
Here, we demonstrate a typical workflow in `GCalignR` using our seal data. All alignment steps that have been described above are implemented within the function **align_chromatograms**. A list of all parameters and their description can be assessed from the documentation in the helpfile by typing \code{?align_chromatograms}. As it is outlined in figure \ref{figure:workflow}, the package provides the function **check_input** to test the input file for typical formatting errors and incomplete data. We encourage to use unique names for samples that consist only of letters, numbers and underscores. If the data fails the test, indicative warnings are returned which guide in correcting those errors. This function ist executed internally prior to any alignment.

```{r}
check_input(fpath)
```

```{r, eval = FALSE}
aligned_peak_data <- align_chromatograms(data = peak_data,
                conc_col_name = "area",
                rt_col_name = "time",
                max_diff_peak2mean = 0.02,
                min_diff_peak2peak = 0.08,
                max_linear_shift = 0.05,
                delete_single_peak = TRUE,
                blanks = c("C2","C3")) # negativ controls
```
Now, we can inspect the results by retrieving summaries of the alignment process. The printing method summarises the function call including defaults that have not been explicitly specified during the function call. We also get the relevant information to retrace every step in the alignment:

```{r}
print(aligned_peak_data)
```

The quality of an alignment will depend on sensible parameters that facilitate the (i) correction of linear shifts that might fall in a larger range with increasing sample size and (ii) and the variability of retention times. Optimally, linear shifts do not exhaust the range given by `max_linear_shift` completely, which would in turn indicate that not all uncertainties haven been fully compensated for. This can be assessed by four diagnostic plots that can be created alltogether as well as individually.

```{r, fig.width = 6, fig.height = 6}
plot(aligned_peak_data)
```
The distribution of peak number before and after the alignment reveals a noticeable reduction of peaks in the aligned dataset. These changes can be explained by the removal of contamimations (i.e. peaks present in blanks) and the removal of single peaks. Type \code{print(aligned_peak_data)} for details on both. The distribution of shifts size used for linear transformations shows a marginal linear trend across the chromatography run. 
Besides the pure number of peaks it is of major interest to inspect the distribution of substances in the pool of samples and access the variation in retention times. This can be investigated simultaneously with a heatmap.

```{r, fig.height = 6, fig.width = 6}
gc_heatmap(aligned_peak_data,type = "discrete", substance_subset = 1:25, samples_subset = 1:25)
```
The heatmap indicates the presence of a certain substance within a sample by a colour-filled box, whereas the absense is encoded by a white box. Furthermore a colour-gradient is used to indicate the deviation of each retention time from the mean value among all other samples as a measure of variation. 
\bibliography{ottensmann-stoffel-hoffman}