---
title: 'GCalignR: An R package for aligning Gas-Chromatography data'
author: "Meinolf Ottensmann, Martin A. Stoffel, Barbara Caspers, Joseph I. Hoffman"
date: '`r Sys.Date()`'
output:
  html_document:
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: yes
    theme: cerulean
  pdf_document:
    fig_caption: yes
    highlight: kate
    keep_tex: yes
    number_sections: yes
  word_document: default
bibliography: bibliographyMO.bib
---

```{r, echo=FALSE, results='hide'}
  # devtools::install_github("cboettig/knitcitations@v1")
  library(knitcitations)
  cleanbib()
  cite_options(citation_format = "pandoc", check.entries = FALSE)
  library(bibtex)
``` 

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", cache = TRUE) # warning = FALSE
```


# Abstract

Key-words: GC-MS,gas-chromatography, chemical communication, olfactory communication, alignment

	
## Introduction

Chemical cues are arguably the most common mode of communication in animals [@Wyatt.2014], where the role is evident in kin [@Porter.1981; @Krause.2012; @Gilad.2016] and mate recognition [@Martin.2008], mate-choice [@Penn.2002] and signalling of genetic quality [@Charpentier.2010; @Stoffel.2015]. The investigation of chemical signatures requires the use of metabolomic approaches in order to characterise and compare the involved chemicals. Gas-chromatography is a widespread analytical method to unravel the compostition of samples with high efficiency [@McNair.2011]. For the detection of broader patterns in chemical samples researchers use an untargeted approach and analyse the whole spectrum of sampled chemicals rather than targeting specific compounds. However, chromatography data across multiple samples are not directly comparable as they need to be aligned first. Furthermore, the retention times of peaks vary across samples due to subtle, random and often unavoidable variation of the chromatograph machine parameters [@Pierce.2005 and references within]. For studies that seek to identify chemical patterns across samples it becomes essential to account for these retention time drifts by using an appropriate alignment method. A number of automated tools is available for two-dimensional chromatograms (LC-MS, GC-MS) which offer mass spectra in addition to retention times [@Pierce.2005; @Smith.2006; @Robinson.2007; @Luedemann.2008; @Koh.2010; @Jiang.2013; @Zhang.2012; @Niu.2014; @Smith.2015], while there is to our knowledge only one application proposed for the needs of one-dimensional chromatograms [@Dellicour.2013]. As a consequence, many researchers rely on a manual alignment of their data [@Charpentier.2010; @Caspers.2011;@Harris.2012]; (Citations are critical. Because nothing is mentioned on alignment within papers, cf. http://bit.ly/2gYJAZw). This approach bears three main drawbacks: (1) In large scale studies the task becomes a difficult and time consuming task. (2) Humans are prone to detect patterns in noise which is why the researcher may bias the alignment due to subjective experience and expectations. (3) The data analytic pipeline from the raw gas-chromatography data to the results of the statistical analysis is not reproducible. 
Here, we introduce `GCalignR`, a package developed in the language `R` [@RCoreTeam.2016], which provides a simple and fast algorithm to align peaks from GC data and evaluate the alignment of empirical data.`GCalignR` was specifically developed and tested as a preprocessing tool prior to the statistical analysis of chemical samples from animal skin and preen glands (see @Stoffel.2015 for an application of the underlying algorithm). The main focus of the package is set on the alignment of homologous retention times and the inspection of the resulting data. The algorithm consists of two main steps: (1) Systematic shifts of chromatograms are corrected by applying appropriate linear shifts to whole chromatograms based on a single reference. (2) Retention times of individual peaks are step-wise grouped together with homologous peaks of other samples within one row. The outcome of this grouping procedures can be altered by specifying three parameters that are described below. Among several optional processing steps, the package allows to remove peaks belonging to contaminations, which are identified due to there presence in control samples. 
Furthermore we demonstrate the easy integration of the R-packge `vegan`[@Oksanen.2016] into a solid workflow for multivariate analyses of chemical data, which can be fully integrated into  in `Rmarkdown` documents [@Allaire.2016] to fullfil good standards of reproducibility [@Peng.2011].
 

## Material and Methods

#### maybe a flowdiagram (package DiagramR) to illustrate the complete workflow ###

```{r}
```

1. GC / GC-MS analysis
2. Peak detection software
3. GCalignR workflow
4. statistical analysis

## Input data 
Peaks have to be extracted from raw chromatogram files using proprietary or freew software prior to alignment with GCalignR. 
The standard working format of `GCalignR`is text file containing peak retention times and a arbitrary number of further variables (see Supporting information A). Additionally the use of `lists` in R is supported. 
`GCalignR` aligns peaks via their retention times (and not their mass-spectra, which may not be available, e.g. when 
using gas-chromatography coupled to a flame ionization detector (FID)) to align the peaks across individuals for subsequent chemometric analysis and pattern detection .The simple assumption is that peaks with similar retention times
represent the same substances. However, it is highly recommended to verify this assumption by
comparing also the mass-spectra (if available) of the substances of interest.
The final data is returned either in form of a list within R or saved as text files (.txt)

# Example dataset

#### explanation of example dataset ####

```{r, eval=FALSE, echo = FALSE} 
library(GCalignR)
data("peak_data")
```

# GCalignR workflow

- GCalignR steps: Checking the input, aligning chromatograms, evaluating alignment
- adjust parameters, align again, evaluate again (if first alignment wasnÂ´t satisfactory)


# Input

- Quickly describe input formats
- Check input and what it checks

```{r, eval=FALSE} 
check_input(data = peak_data,show_peaks = T, col= "red") # If show_peaks = T, a histogram of peaks is plotted 
```


# Aligning peaks

- describe main features of the main function

```{r, results= "hide", eval=FALSE} 
peak_data_aligned <- align_chromatograms(data = gc_peak_data, # input data
    conc_col_name = "area", # peak abundance variable
    rt_col_name = "time", # retention time 
    rt_cutoff_low = 5, # cut peaks with retention times below 5 Minutes
    rt_cutoff_high = 45, # cut peaks with retention times above 45 Minutes
    reference = "M3", # name of reference 
    max_linear_shift = 0.05, # maximum linear shift of chromatograms
    max_diff_peak2mean = 0.03, # maximum distance of a peak to the mean
    min_diff_peak2peak = 0.03, # maximum distance between the mean of two peaks
    blanks = NULL, # no blanks. Specify blanks by names (e.g. c("blank1", "blank2"))
    delete_single_peak = TRUE, # delete peaks that are present in just one sample 
    write_output = NULL) # add c("time","area") to write data frames to .txt file
```

```{r, echo = "hide", eval=FALSE} 
data("aligned_peak_data")
```

# Evaluating the quality of the alignment

```{r, echo = "hide"} 
library(ggplot2)
library(gridExtra)
```


```{r,eval=FALSE} 
gc_heatmap(aligned_peak_data,threshold = 0.01, samples_subset = 1:20, substance_subset = 1:30, label_size = 10, type = "continous") # By default a threshold of 0.05 is used to mark deviations
```

# Algorithm

# Evaluation with empirical data and simulations


## Availability

The latest version of `GCalignR` can be downloaded from GitHub.

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("mastoffel/GCalignR")
```

We welcome any contributions or feedback on the package.

## Data accessibility


## References




