---
title: 'GCalignR: An R package for aligning Gas-Chromatography data'
author: "Meinolf Ottensmann, Martin A. Stoffel, Barbara Casper, Joseph I. Hoffman"
date: "11/1/2015"
output:
  pdf_document:
    fig_caption: yes
    highlight: kate
    keep_tex: yes
    number_sections: yes
  html_document:
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: yes
    theme: cerulean
  word_document: default
bibliography: bibliography.bib
---

```{r, echo=FALSE, results='hide'}
  # devtools::install_github("cboettig/knitcitations@v1")
  library(knitcitations)
  cleanbib()
  cite_options(citation_format = "pandoc", check.entries=FALSE)
  library(bibtex)
``` 

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", cache = TRUE) # warning = FALSE
```


# Abstract


Key-words: GC-MS, chemical communication, olfactory communication, alignment

	
## Introduction

Metabolomics approaches such as Gas Chromatography (GC) and Gas Chromatography-Mass Spectrometry (GC-MS) are increasingly used by biologists to unravel the chemical basis of animal behaviour, such as olfactory communication or navigation (citations). As hyFor the detection of broader patterns in chemical samples most researchers use an untargeted approach and analyse the whole spectrum of sampled chemicals rather than targeting specific compounds. However, 
chromatography data across multiple samples are not directly comparable as the retention times of peaks
vary across samples due to subtle, random and often unavoidable variation of the GC-MS machine parameters [@pierce2005classification]. For studies that seek to identify chemical patterns across samples it becomes essential to account for these retention time drifts by using an appropriate alignment method.

Despite the existence of automated alignment algorithms [e.g. @smith2006xcms; @stein1999integrated; @robinson2007dynamic] (also gcaligner here), most researchers in the relatively young fields of mammalian and avian chemical communication align chromatograms manually [@charpentier2008smelling; @setchell2010odour; @caspers2011scents; @leclaire2012semiochemical; @theis2013symbiotic] or identify all compounds prior to analysis [@whittaker2010songbird] rather than using (semi-)automated alignment software. This approach yields three main drawbacks: (1) For larger sample sizes, the method is time intensive and can take up to several weeks. (2) Humans are prone to detect patterns in noise (some citation) which is why the researcher may bias the alignment due to subjective experience and expectations. (3) The data analytic pipeline from the raw GC data to the results of the statistical analysis is not reproducible. 

Here, we introduce `GCalignR`, a package developed in R, which provides a simple means of aligning peaks from Gas Chromatography data and evaluate the quality of the alignment.  `GCalignR` was specifically developed and tested as a preprocessing tool prior to the statistical analysis of chemical samples from animal skin and preen glands [see @stoffel2015chemical for an application of the underlying algorithm]. The alignment functions can easily be embedded in reproducible research tools such as `Rmarkdown` (citation?) and piped as input into
further statistical packages such as `vegan`.



# The package

#### maybe a flowdiagram (package DiagramR) to illustrate the complete workflow ###

1. GC / GC-MS analysis
2. Peak detection software
3. GCalignR workflow
4. statistical analysis

## Data preprocessing 

The statistical analysis of GC or GC-MS data is usually based on the detection of signal peaks within
the chromatograms, which is can be done by proprietary software or free programs such as AMDIS [@stein1999integrated].
The peak data of a chromatogramm usually contain the retention time of a given peak plus additional information such 
as the area under the peak or its height which are used in the subsequent analysis. 
`GCalignR` aligns peaks via their retention times (and not their mass-spectra, which may not be available, e.g. when 
using gas-chromatography coupled to a flame ionization detector (FID)) to align the peaks across individuals for subsequent chemometric analysis and pattern detection .The simple assumption is that peaks with similar retention times
represent the same substances. However, it is highly recommended to verify this assumption by
comparing also the mass-spectra (if available) of the substances of interest.


# Example dataset

#### explanation of example dataset ####

```{r, echo = FALSE} 
library(GCalignR)
data("peak_data")
```

# GCalignR workflow

- GCalignR steps: Checking the input, aligning chromatograms, evaluating alignment
- adjust parameters, align again, evaluate again (if first alignment wasnÂ´t satisfactory)


# Input

- Quickly describe input formats
- Check input and what it checks

```{r} 
check_input(data = peak_data,show_peaks = T, col= "red") # If show_peaks = T, a histogram of peaks is plotted 
```


# Aligning peaks

- describe main features of the main function

```{r, results= "hide", eval=FALSE} 
peak_data_aligned <- align_chromatograms(data = gc_peak_data, # input data
    conc_col_name = "area", # peak abundance variable
    rt_col_name = "time", # retention time 
    rt_cutoff_low = 5, # cut peaks with retention times below 5 Minutes
    rt_cutoff_high = 45, # cut peaks with retention times above 45 Minutes
    reference = "M3", # name of reference 
    max_linear_shift = 0.05, # maximum linear shift of chromatograms
    max_diff_peak2mean = 0.03, # maximum distance of a peak to the mean
    min_diff_peak2peak = 0.03, # maximum distance between the mean of two peaks
    blanks = NULL, # no blanks. Specify blanks by names (e.g. c("blank1", "blank2"))
    delete_single_peak = TRUE, # delete peaks that are present in just one sample 
    write_output = NULL) # add c("time","area") to write data frames to .txt file
```

```{r, echo = "hide"} 
data("aligned_peak_data")
```

# Evaluating the quality of the alignment

```{r, echo = "hide"} 
library(ggplot2)
library(gridExtra)
```


```{r} 
gc_heatmap(aligned_peak_data,threshold = 0.01, samples_subset = 1:20, substance_subset = 1:30, label_size = 10, type = "continous") # By default a threshold of 0.05 is used to mark deviations
```

# Algorithm

# Evaluation with empirical data and simulations


## Availability

The latest version of `GCalignR` can be downloaded from GitHub.

```{r, eval = FALSE}
install.packages("devtools")
devtools::install_github("mastoffel/GCalignR")
```

We welcome any contributions or feedback on the package.

## Data accessibility


## References




